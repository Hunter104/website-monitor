#!/usr/bin/env bash
: "${HOOK_URL:?}"
export LC_NUMERIC=C

send_message() { curl -s -X POST -F "content=$1" "$HOOK_URL"; }
query() { sqlite3 monitor-db "$1" || { echo "Query failed: $1" >&2; exit 1; }; }

check_website() {
  IFS='|' read -r id url name last_status _ <<< "$1"
  tmp_error=$(mktemp -t website-monitor.XXXXXX)

  time=$(curl -LIsSf --retry 3 --max-time 10 "$url" -w '%{time_total}' -o /dev/null -v 2>"$tmp_error")
  exit_code=$?

  case $exit_code in 
    0) status="UP" ;;
    22|28) status="DOWN" ;; 
    *) status="$last_status" ;; 
  esac

  next_state=$(awk "NR>1{if (\$1 == \"$last_status\" && \$2 == \"$status\") print \$3}" status_table)
  if [[ -z $next_state ]]; then 
    echo "Couldn't find next state for last: $last_status current: $status"
    exit 1
  fi

  query "UPDATE Website SET last_status='$next_state' WHERE id=$id;"
  [[ $exit_code -ne 0 ]] && cat "$tmp_error"
  [[ $next_state == "$last_status" ]] && { rm "$tmp_error"; return; }
  printf "Status change detected [%s] %s (%.2fs)\n" "$next_state" "$url" "${time:-0}"
  if [[ "$status" == "UP" ]]; then
    send_message "âœ… **$name** estÃ¡ online!"
  elif [[ "$status" == "DOWN" ]]; then 
    send_message "âŒ **$name** estÃ¡ fora do ar! ğŸ˜" 
  fi
  rm "$tmp_error"
}

export -f check_website send_message query
query 'SELECT * FROM Website' | xargs -P4 -I{} bash -c 'check_website "$@"' _ "{}"
